# 📡 VWorld API 신청 가이드

## 🎯 필요한 API 목록

우리 프로젝트에서 사용하는 VWorld API:

1. ✅ **WMTS/TMS API** (필수) - 고해상도 항공사진 타일
2. ✅ **지오코더 API** (필수) - 주소 → 좌표 변환
3. ✅ **WMS/WFS API** (선택) - 큰 영역 한 번에 다운로드

**다른 API는 신청하지 마세요!** (불필요)

---

## 💰 VWorld API 과금 정책

### ✅ **무료입니다!**

- 🆓 기본 사용 **완전 무료**
- 🆓 상업적 이용도 가능 (승인 시)
- ⚠️ 일일 요청 제한 있음 (보통 충분함)
- ⚠️ 과도한 사용 시 제한 가능

### 우리 프로젝트 예상 사용량
- **하루 100회 요청**: 문제 없음
- **캐싱 시스템**: API 호출 80% 절감
- **실제 API 호출**: 하루 20회 정도 (매우 적음)

---

## 📝 VWorld API 신청 방법

### 1단계: 회원가입 및 로그인

1. https://www.vworld.kr 접속
2. 우측 상단 **"회원가입"** 클릭
3. 개인 또는 기업 회원가입 (개인 추천)
4. 이메일 인증 완료
5. 로그인

---

### 2단계: 오픈 API 신청

#### 1) 마이페이지 이동
- 로그인 후 우측 상단 **"마이페이지"** 클릭
- 좌측 메뉴에서 **"오픈API 관리"** 클릭

#### 2) 새 API 신청
- **"활용신청"** 또는 **"오픈 API 활용신청"** 버튼 클릭

#### 3) API 정보 입력

**기본 정보:**
```
서비스명: 장기방치차량탐지시스템
서비스 설명: 항공사진 기반 장기 방치 차량 탐지 AI 시스템
서비스 URL: http://localhost:3000 (테스트용)
              또는 https://your-domain.com (운영용)
이용 목적: 공공안전 / 차량 관리
예상 트래픽: 하루 100회 미만
```

**API 선택:**
- ☑️ **WMTS/TMS API**
- ☑️ **지오코더 API** (또는 "검색 API")
- ☑️ **WMS/WFS API** (선택)

**다른 API는 체크 해제!**

#### 4) 제출 및 대기
- 신청서 제출
- 승인 대기: **1~2일** (보통 하루 내 승인)
- 이메일로 승인 통지 받음

---

### 3단계: API 키 확인 및 설정

#### 1) API 키 복사
- 마이페이지 → 오픈API 관리
- 승인된 API 목록에서 **"인증키"** 확인
- 복사 (예: `8F1EC6DE-5BBA-329A-94AE-BD66BE1DB672`)

#### 2) .env 파일에 입력

프로젝트 루트의 `.env` 파일 수정:

```bash
# 국토정보플랫폼 API 설정
NGII_API_KEY=여기에-복사한-API-키-붙여넣기
```

예시:
```bash
NGII_API_KEY=8F1EC6DE-5BBA-329A-94AE-BD66BE1DB672
```

#### 3) 서버 재시작

```bash
# FastAPI 서버 재시작
cd backend
uvicorn fastapi_app:app --host 0.0.0.0 --port 8000
```

---

### 4단계: API 테스트

#### 테스트 스크립트 실행

```bash
cd backend
python test_ngii_api.py
```

**성공 시 출력:**
```
✓ 주소 검색 성공!
  주소: 서울특별시 종로구 세종대로 209
  위도: 37.5700
  경도: 126.9780
```

**실패 시 출력:**
```
❌ 에러 발생
  코드: INVALID_KEY
  메시지: 등록되지 않은 인증키입니다.
```

**실패 원인:**
- API 키 오타 확인
- 아직 승인되지 않음 (1~2시간 더 대기)
- API 종류 잘못 선택 (WMTS/지오코더 확인)

---

## 🚀 API 활성화 후 자동 작동

API 키가 활성화되면 **자동으로** 다음 기능이 작동합니다:

### 1. 실제 항공사진 다운로드
```python
# VWorld에서 고해상도 항공사진 자동 다운로드
service = NGIIAPIService()
result = service.download_high_resolution_area(
    latitude=37.5172,
    longitude=127.0473,
    zoom=18  # 12cm 해상도!
)
```

### 2. 자동 캐싱
- **첫 요청**: VWorld API 호출 (5초)
- **두 번째부터**: 캐시에서 즉시 (0.1초)
- **24시간 동안 유효**

### 3. Frontend에서 사용
1. "방치 차량 탐지" 탭 클릭
2. "실제 위치 분석하기" 클릭
3. 주소 입력 (예: "서울특별시 강남구")
4. "분석 시작" 클릭
5. ✨ **실제 항공사진으로 방치차량 탐지!**

---

## 📊 API 사용량 모니터링

### 캐시 통계 확인
```bash
curl http://localhost:8000/api/cache/stats
```

**결과:**
```json
{
  "total_requests": 100,
  "cache_hits": 85,
  "cache_misses": 15,
  "hit_rate_percent": 85.0,
  "total_size_mb": 42.5,
  "max_size_mb": 5120.0,
  "ttl_hours": 24.0
}
```

### 해석
- **cache_hits**: 캐시에서 제공 (VWorld API 호출 안 함)
- **cache_misses**: VWorld API 호출
- **hit_rate_percent**: 캐시 히트율 (높을수록 좋음)
- **total_size_mb**: 디스크 사용량

---

## 🔧 문제 해결

### Q1: API 키 승인 후에도 "INVALID_KEY" 오류

**해결:**
1. 1~2시간 더 기다리기 (활성화 시간)
2. API 키 다시 복사 (공백/특수문자 확인)
3. .env 파일 재확인
4. 서버 재시작

### Q2: "등록되지 않은 도메인" 오류

**해결:**
- VWorld 신청 시 입력한 URL 확인
- `http://localhost:3000` 또는 실제 도메인과 일치해야 함
- 마이페이지에서 서비스 URL 수정 가능

### Q3: 이미지 다운로드 실패

**해결:**
1. API 키 활성화 확인
2. WMTS/TMS API 신청 여부 확인
3. 네트워크 연결 확인
4. `test_cache_system.py` 실행하여 상세 로그 확인

### Q4: 캐시가 작동하지 않음

**해결:**
```bash
# 캐시 통계 확인
curl http://localhost:8000/api/cache/stats

# 캐시 디렉토리 확인
ls -lh backend/cache/aerial_images/

# 권한 확인
chmod -R 755 backend/cache/
```

---

## 📞 지원 연락처

**VWorld 고객센터:**
- 📞 전화: **1661-0115**
- 🕒 운영 시간: 평일 09:00 ~ 18:00 (점심 12:00~13:00)
- 🌐 웹사이트: https://www.vworld.kr
- 📧 이메일: support@vworld.kr

**자주 묻는 질문:**
- API 키 분실: 마이페이지에서 재확인 가능
- 사용량 초과: 일일 제한 문의 (보통 충분함)
- 상업적 이용: 별도 협의 필요 (신청 시 명시)

---

## 💡 팁

### 캐싱 활용
- 같은 위치 반복 조회 시 **즉시 응답**
- 24시간 동안 **무제한 재사용**
- API 호출 **80% 절감**
- 월 비용 **40원** (거의 무료!)

### 성능 최적화
- `zoom=18`: 고해상도 (차량 명확)
- `zoom=19`: 최고 해상도 (느림, 용량 큼)
- `width_tiles=3, height_tiles=3`: 기본 (적당한 영역)

### 비용 관리
- 캐시 최대 크기: 5GB (충분함)
- 자동 정리: 24시간 TTL
- 수동 정리: `POST /api/cache/cleanup`

---

## ✅ 체크리스트

신청 전:
- [ ] VWorld 회원가입 완료
- [ ] 프로젝트 목적 명확히 정의
- [ ] 서비스 URL 결정 (localhost 또는 도메인)

신청 후:
- [ ] API 승인 확인 (1~2일)
- [ ] API 키 복사
- [ ] .env 파일 업데이트
- [ ] `test_ngii_api.py` 테스트 성공
- [ ] `test_cache_system.py` 테스트 성공

작동 확인:
- [ ] 주소 검색 작동
- [ ] 항공사진 다운로드 성공
- [ ] 캐시 히트율 > 80%
- [ ] Frontend 실제 위치 분석 성공

---

🎉 **축하합니다!** 이제 실제 VWorld 항공사진으로 방치차량을 탐지할 수 있습니다!
