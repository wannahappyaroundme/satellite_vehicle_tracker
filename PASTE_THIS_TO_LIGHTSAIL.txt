# ============================================================
# Lightsail ë¸Œë¼ìš°ì € SSHì— ì´ ì „ì²´ë¥¼ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!
# ============================================================

cd /home/ubuntu/satellite_vehicle_tracker/backend

cat > seed_dummy_data.py << 'ENDPYTHON'
#!/usr/bin/env python3
import sys
import random
from datetime import datetime
from pathlib import Path

backend_dir = Path(__file__).parent
sys.path.insert(0, str(backend_dir))

from database import get_db
from models_sqlalchemy import AbandonedVehicle

LOCATIONS = [
    {"city": "ì„œìš¸ ê°•ë‚¨êµ¬", "lat": 37.4979, "lng": 127.0276},
    {"city": "ì„œìš¸ ì¢…ë¡œêµ¬", "lat": 37.5735, "lng": 126.9788},
    {"city": "ì„œìš¸ ë§ˆí¬êµ¬", "lat": 37.5663, "lng": 126.9019},
    {"city": "ë¶€ì‚° í•´ìš´ëŒ€êµ¬", "lat": 35.1631, "lng": 129.1633},
    {"city": "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬", "lat": 35.1628, "lng": 129.0537},
    {"city": "ëŒ€êµ¬ ì¤‘êµ¬", "lat": 35.8694, "lng": 128.6067},
    {"city": "ì¸ì²œ ë‚¨ë™êµ¬", "lat": 37.4475, "lng": 126.7311},
    {"city": "ê´‘ì£¼ ì„œêµ¬", "lat": 35.1524, "lng": 126.8899},
    {"city": "ëŒ€ì „ ìœ ì„±êµ¬", "lat": 36.3624, "lng": 127.3563},
    {"city": "ìš¸ì‚° ë‚¨êµ¬", "lat": 35.5441, "lng": 129.3311},
    {"city": "ê²½ê¸° ìˆ˜ì›ì‹œ", "lat": 37.2636, "lng": 127.0286},
    {"city": "ê²½ê¸° ì„±ë‚¨ì‹œ", "lat": 37.4449, "lng": 127.1389},
    {"city": "ê²½ê¸° ê³ ì–‘ì‹œ", "lat": 37.6584, "lng": 126.8320},
    {"city": "ì œì£¼ ì œì£¼ì‹œ", "lat": 33.4996, "lng": 126.5312},
    {"city": "ê°•ì› ì¶˜ì²œì‹œ", "lat": 37.8813, "lng": 127.7300},
]

RISK_LEVELS = [
    {"level": "CRITICAL", "weight": 3},
    {"level": "HIGH", "weight": 5},
    {"level": "MEDIUM", "weight": 4},
    {"level": "LOW", "weight": 2},
]

VEHICLE_TYPES = [
    {"type": "small-vehicle", "weight": 7},
    {"type": "large-vehicle", "weight": 2},
    {"type": "truck", "weight": 1},
]

def weighted_choice(choices):
    total = sum(c["weight"] for c in choices)
    r = random.uniform(0, total)
    upto = 0
    for choice in choices:
        if upto + choice["weight"] >= r:
            return choice
        upto += choice["weight"]
    return choices[-1]

def generate_similarity_by_risk(risk_level):
    if risk_level == "CRITICAL":
        return round(random.uniform(0.95, 0.99), 4)
    elif risk_level == "HIGH":
        return round(random.uniform(0.90, 0.949), 4)
    elif risk_level == "MEDIUM":
        return round(random.uniform(0.85, 0.899), 4)
    else:
        return round(random.uniform(0.75, 0.849), 4)

def generate_years_by_risk(risk_level):
    if risk_level == "CRITICAL":
        year1 = random.randint(2015, 2018)
        year2 = year1 + random.randint(3, 6)
    elif risk_level == "HIGH":
        year1 = random.randint(2017, 2020)
        year2 = year1 + random.randint(2, 4)
    elif risk_level == "MEDIUM":
        year1 = random.randint(2019, 2021)
        year2 = year1 + random.randint(1, 3)
    else:
        year1 = random.randint(2020, 2022)
        year2 = year1 + random.randint(1, 2)
    return year1, min(year2, 2024)

def generate_vehicle_description(vehicle_type):
    colors = ["ê²€ì •ìƒ‰", "í°ìƒ‰", "ì€ìƒ‰", "íŒŒë€ìƒ‰", "ë¹¨ê°„ìƒ‰", "íšŒìƒ‰"]
    brands_small = ["í˜„ëŒ€", "ê¸°ì•„", "ì‰ë³´ë ˆ", "ë¥´ë…¸ì‚¼ì„±", "ìŒìš©"]
    brands_large = ["í˜„ëŒ€", "ê¸°ì•„", "ìŒìš©"]
    brands_truck = ["í˜„ëŒ€", "ê¸°ì•„", "íƒ€íƒ€ëŒ€ìš°"]
    color = random.choice(colors)
    if vehicle_type == "small-vehicle":
        brand = random.choice(brands_small)
        model = random.choice(["ì†Œë‚˜íƒ€", "ì•„ë°˜ë–¼", "K5", "ìŠ¤íŒŒí¬", "ëª¨ë‹", "SM3"])
        return f"{color} {brand} {model} (ìŠ¹ìš©ì°¨)"
    elif vehicle_type == "large-vehicle":
        brand = random.choice(brands_large)
        model = random.choice(["ì¹´ë‹ˆë°œ", "ìŠ¤íƒ€ë ‰ìŠ¤", "G4 ë ‰ìŠ¤í„´"])
        return f"{color} {brand} {model} (ëŒ€í˜• ìŠ¹í•©ì°¨)"
    else:
        brand = random.choice(brands_truck)
        model = random.choice(["í¬í„°", "ë´‰ê³ ", "íƒ€ìš°ë„ˆ"])
        return f"{color} {brand} {model} (í™”ë¬¼ì°¨)"

print("=" * 60)
print("ë”ë¯¸ ë°ì´í„° 36ëŒ€ ìƒì„± ì¤‘...")
print("=" * 60)

db = next(get_db())
try:
    existing = db.query(AbandonedVehicle).count()
    print(f"\nê¸°ì¡´ ë°ì´í„°: {existing}ê°œ")

    inserted = 0
    for i in range(36):
        risk_choice = weighted_choice(RISK_LEVELS)
        risk_level = risk_choice["level"]
        vehicle_choice = weighted_choice(VEHICLE_TYPES)
        vehicle_type = vehicle_choice["type"]
        location = random.choice(LOCATIONS)
        lat = location["lat"] + random.uniform(-0.01, 0.01)
        lng = location["lng"] + random.uniform(-0.01, 0.01)
        similarity = generate_similarity_by_risk(risk_level)
        year1, year2 = generate_years_by_risk(risk_level)
        years_diff = year2 - year1
        description = generate_vehicle_description(vehicle_type)
        city_parts = location["city"].split()
        city = city_parts[0]
        district = city_parts[1] if len(city_parts) > 1 else ""
        vehicle_id = f"VH{datetime.now().strftime('%Y%m%d')}{i:04d}"
        bbox = {"x": random.randint(100, 800), "y": random.randint(100, 600), "w": random.randint(60, 120), "h": random.randint(40, 90)}
        metadata = {"year1": year1, "year2": year2, "description": description, "confidence": round(random.uniform(0.85, 0.98), 4)}

        vehicle = AbandonedVehicle(
            vehicle_id=vehicle_id, latitude=round(lat, 6), longitude=round(lng, 6),
            city=city, district=district, address=location["city"], vehicle_type=vehicle_type,
            similarity_score=similarity, similarity_percentage=similarity * 100,
            risk_level=risk_level, years_difference=years_diff,
            first_detected=datetime.now(), last_detected=datetime.now(),
            detection_count=random.randint(1, 5), avg_similarity=similarity,
            max_similarity=min(similarity + random.uniform(0, 0.05), 1.0),
            status="DETECTED", bbox_data=bbox, extra_metadata=metadata
        )
        db.add(vehicle)
        inserted += 1

    db.commit()
    total = db.query(AbandonedVehicle).count()
    print(f"\nâœ… {inserted}ëŒ€ ì¶”ê°€ ì™„ë£Œ!")
    print(f"âœ… ì´ ë°ì´í„°: {total}ê°œ")

    print("\n[ìœ„í—˜ë„ë³„ ë¶„í¬]")
    for risk in ["CRITICAL", "HIGH", "MEDIUM", "LOW"]:
        count = db.query(AbandonedVehicle).filter(AbandonedVehicle.risk_level == risk).count()
        pct = (count / total) * 100 if total > 0 else 0
        print(f"  {risk}: {count}ëŒ€ ({pct:.1f}%)")

    print("\n" + "=" * 60)
    print("âœ… ë°°í¬ ì™„ë£Œ!")
    print("=" * 60)
except Exception as e:
    db.rollback()
    print(f"\nâŒ ì—ëŸ¬: {e}")
    import traceback
    traceback.print_exc()
finally:
    db.close()
ENDPYTHON

source venv/bin/activate
python seed_dummy_data.py

echo ""
echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
sudo supervisorctl restart satellite-backend
sleep 3

echo ""
echo "âœ… ë°°í¬ ì™„ë£Œ! ì°¨ëŸ‰ ìˆ˜ í™•ì¸:"
curl -s http://localhost:8000/api/abandoned-vehicles 2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); print(f'{len(data)}ëŒ€')" 2>/dev/null || echo "í™•ì¸ ì¤‘..."

echo ""
echo "ğŸŒ Cloudflare Tunnelë¡œ í™•ì¸:"
echo "   https://standings-classification-easy-textbook.trycloudflare.com/api/abandoned-vehicles"
echo ""
echo "ğŸ“± GitHub Pages:"
echo "   https://wannahappyaroundme.github.io/satellite_vehicle_tracker/"
echo ""
echo "âœ… ì™„ë£Œ!"
